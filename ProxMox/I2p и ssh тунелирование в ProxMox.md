# I2p и ssh тунелирование в ProxMox
## Проблема с доступом к web интерфейсу ProxMox

    apt-get update
    apt-get -y upgrade
    
Необходимо обновить систему но в случаи возникновения ошибок при обновлении делаем следующее 

    nano /etc/apt/sources.list.d/pve-enterprise.list 
    
закоментируем единственную строчку в этом файле, это вроде как какой то платный репозиторий

Так же автоматически могут указатсья не правильные dns сервера что бы это исправить переходим в 
/etc/resolv.conf и прописываем там dns гугла 8.8.8.8 и 8.8.4.4

    apt update && apt -y upgrade

## Проблема с desktop в виртуалках

Устанавливаем серверную версию операционной системы в качестве VM и выполняем следующую инструкцию

    apt-get install xorg i3 lightdm
    reboot

## Установка i2p

(Инструкция приведенная далее аналогична и для установки i2p в отдельный контейнер и проброс ssh тунеля в него из пользовательской os)

>Источник: https://geti2p.net/en/download/debian

    apt-get update
    apt-get install apt-transport-https curl
    nano /etc/apt/sources.list.d/i2p.list

Указываем репозитории:

    deb https://deb.i2p2.de/ buster main
    deb-src https://deb.i2p2.de/ buster main
    
Устанавливаем i2p

    apt-get install i2p
    curl -o i2p-debian-repo.key.asc https://geti2p.net/_static/i2p-debian-repo.key.asc
    gpg -n --import --import-options import-show i2p-debian-repo.key.asc
    apt-key add i2p-debian-repo.key.asc
    apt-get update
    apt-get install i2p i2p-keyring

    nano /etc/default/i2p

Вписываем: 

    RUN_AS_USER="i2p"

Добавляем нового пользователя в систему:

    useradd i2p

    passwd i2p

Новому пользователю i2p нужен доступ к /home/i2p

    chmod 777 /home

Я для теста выдал папке /home права 777 и все заработало - не делать так в релизе, надо выдать права только пользователю i2p

Запусканм i2p:

    su i2p

    i2prouter start

Для того что бы убедиться что i2prouter запустился: 

    i2prouter status

IP консоли i2p 127.0.0.1:7657

Переходим по адресу 127.0.0.1:7657/config 
настраиваем пропускную способность

Не забываем прописать в браузере прокси на http и https 
на адрес 127.0.0.1 и порты 4444 - для http и 4445 - для https

В моем случае пришлось перезапустить ось и роутер для того что бы комп с осью появился в списке клиентов роутера работающих по upnp протоколу

## Настройка доступа к i2p из пользовательской os:

на оси проходим по адресу 127.0.0.1:7657/i2ptunnelmgr

Для I2P HTTP PROXY и I2P HTTPS PROXY меняем адресс с 127.0.0.1 на 0.0.0.0

Прокладования ssh  тунеля на клиенте - пользовательской os:

(Тунель не сохраняется после перезагрузки, нужно написать bash скрипт)

для доступа к панели настрйоки i2p:

    ssh i2p@192.168.1.102 -L7657:127.0.0.1:7657 

для всего другого трафика:

    ssh i2p@192.168.1.102 -L4444:127.0.0.1:4444

Указываем в браузере прокси по адресу 127.0.0.1 4444 для всех протоколов

Кстати можно расширить адресную книгу находящуюеся по адресу 192.168.1.102:8006 в вкладке файл подписок вписываем:

    http://i2host.i2p/cgi-bin/i2hostetag
    http://stats.i2p/cgi-bin/newhosts.txt
    http://no.i2p/export/alive-hosts.txt

После внесение изменений в файл подписок необходимо перезапустить i2p

(Текстовые файлы конфигурации i2p находится /home/i2p/.i2p)

## Выход в сеть i2p и в обычную сеть через один браузер

Создаем гденибуть на компьютере файл с расширением .pac и прописываем в нем следующее:

function FindProxyForURL(url, host) {
    if (dnsDomainIs(host, ".i2p")) {
        return "PROXY 127.0.0.1:4444";
    } else {
        return "DIRECT";
    }
}

В браузере указываем proxy через url вписываем туда путь до файла от корневой директории
можно указать локальный url а можно сослаться на web сервер находящийся к примеру на оси

